document.addEventListener("DOMContentLoaded",()=>{(async function(){let e=sessionStorage.getItem("selectedROCode");try{const t=await getDistrictByName(e);const n=document.getElementById("gaName");const a=t.split(":");a.forEach(e=>{if(e.trim()!==""){const t=document.createElement("option");t.value=e;t.text=e;n.add(t)}})}catch(e){console.error("Error fetching GA names:",e)}})()});document.getElementById("gaName").addEventListener("change",function(){this.style.fontSize="75%"});const form=document.querySelector("#loading-form");const roCodeInput=document.querySelector("#roCode");const lcvRegNumInput=document.querySelector("#lcvRegNum");const dateInput=document.querySelector("#date");const timeInput=document.querySelector("#time");const initialReadingInput=document.querySelector("#initialReading");const finalReadingInput=document.querySelector("#finalReading");const quantityLoadedInput=document.querySelector("#quantityLoaded");const startMfmReadingInput=document.querySelector("#startMfmReading");const endMfmReadingInput=document.querySelector("#endMfmReading");const submitBtn=document.querySelector("#submit-btn");const fetchROCode=()=>{const e=sessionStorage.getItem("selectedROCode");if(e){roCodeInput.value=e}else{roCodeInput.value="UNAUTHORISED USER"}};const fetchDateTime=()=>{const e=new Date;const t=e.toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g,".");const n=e.toLocaleTimeString("en-GB",{hour12:false,hour:"2-digit",minute:"2-digit",second:"2-digit"});dateInput.value=t;timeInput.value=n};const calculateQuantityLoaded=()=>{const e=parseFloat(initialReadingInput.value);const t=parseFloat(finalReadingInput.value);const n=t-e;quantityLoadedInput.value=n.toFixed(2);if(n<0){quantityLoadedInput.classList.add("is-invalid");alert("Quantity unloaded cannot be negative.")}else{quantityLoadedInput.classList.remove("is-invalid")}};const validateForm=()=>{const e=document.getElementById("gaName");if(e.value===""){alert("Please select a GA Name.");return false}if(!lcvRegNumInput.value||!initialReadingInput.value||!finalReadingInput.value){alert("Please fill in all required fields.");return false}if(parseFloat(quantityLoadedInput.value)<=0){alert("Quantity unloaded must be greater than 0.");return false}if(!startMfmReadingInput.value||!endMfmReadingInput.value){alert("Please upload both MFM initial and final readings.");return false}return true};const resizeImage=o=>{return new Promise((a,e)=>{const t=new FileReader;t.onload=e=>{const n=new Image;n.onload=()=>{const e=document.createElement("canvas");const t=e.getContext("2d");e.width=500;e.height=500;t.drawImage(n,0,0,500,500);e.toBlob(e=>{a(e)},o.type)};n.src=e.target.result};t.onerror=e;t.readAsDataURL(o)})};const handleFormSubmit=async e=>{e.preventDefault();if(!validateForm())return;if(roCodeInput.value==="UNAUTHORISED USER"){alert("Unauthorized user. Form submission is not allowed.");return}const t=startMfmReadingInput.files[0];const n=endMfmReadingInput.files[0];try{const a=t?await resizeImage(t):null;const o=n?await resizeImage(n):null;const i=new FileReader;const l=new FileReader;const s=new Promise((e,t)=>{i.onload=function(){e(i.result.split(",")[1])};i.onerror=t;if(a){i.readAsDataURL(a)}else{e("")}});const d=new Promise((e,t)=>{l.onload=function(){e(l.result.split(",")[1])};l.onerror=t;if(o){l.readAsDataURL(o)}else{e("")}});const[u,r]=await Promise.all([s,d]);const c={gaName:document.getElementById("gaName").value,roCode:roCodeInput.value,lcvRegNum:lcvRegNumInput.value,date:dateInput.value,time:timeInput.value,initialReading:initialReadingInput.value,finalReading:finalReadingInput.value,quantityLoaded:quantityLoadedInput.value,startMfmBase64:u,endMfmBase64:r};sessionStorage.setItem("time",timeInput.value);sessionStorage.setItem("date",dateInput.value);sessionStorage.setItem("quantityloaded",quantityLoadedInput.value);sessionStorage.setItem("ganame",document.getElementById("gaName").value);sessionStorage.setItem("lcv",lcvRegNumInput.value);fetch("https://script.google.com/macros/s/AKfycbxtheRDUPKt0PoYs4N0Og0S0ZhH0_JBBauCgFfpgDfOiWmq9Ho6VNLrqLPwWOQR7Z_y/exec",{method:"POST",body:JSON.stringify(c)}).then(e=>console.log("Form submitted:",c)).catch(e=>{console.error("Error:",e);window.location.href="receipt.html"})}catch(e){console.error("Error resizing file:",e)}};fetchROCode();fetchDateTime();initialReadingInput.addEventListener("change",calculateQuantityLoaded);finalReadingInput.addEventListener("change",calculateQuantityLoaded);submitBtn.addEventListener("click",handleFormSubmit);startMfmReadingInput.addEventListener("change",()=>{const e=startMfmReadingInput.value.split("\\").pop();const t=e.split(".").pop().toLowerCase();if(t!=="jpg"&&t!=="jpeg"&&t!=="png"){alert("Please upload a photo file (JPG, JPEG, PNG) for MFM Initial Reading.");startMfmReadingInput.value=""}});endMfmReadingInput.addEventListener("change",()=>{const e=endMfmReadingInput.value.split("\\").pop();const t=e.split(".").pop().toLowerCase();if(t!=="jpg"&&t!=="jpeg"&&t!=="png"){alert("Please upload a photo file (JPG, JPEG, PNG) for MFM Final Reading.");endMfmReadingInput.value=""}});